import { useParams, useNavigate } from "react-router-dom";
import { useState, useEffect, useRef } from "react";
import ChatHeader from "../components/ChatHeader";
import ChatMessages from "../components/ChatMessages";
import ChatInput from "../components/ChatInput";
import "./ChatRoom.scss";

function ChatRoom() {
  const { id } = useParams();
  const navigate = useNavigate();
  const [messages, setMessages] = useState([]);
  const ws = useRef(null);
  const [user, setUser] = useState(null);
  const [sending, setSending] = useState(false);

  //  ë¡œê·¸ì¸ëœ ì‚¬ìš©ì ë¶ˆëŸ¬ì˜¤ê¸°
  useEffect(() => {
    const userData = localStorage.getItem("user");
    if (userData) {
      const parsedUser = JSON.parse(userData);
      setUser(parsedUser.username); // ì‹¤ì œ í•„ë“œëª…(username or name) ë§ê²Œ ìˆ˜ì •
      console.log(" ë¡œê·¸ì¸ ì‚¬ìš©ì:", parsedUser.username);
    }
  }, []);

  //  ì›¹ì†Œì¼“ ì—°ê²°
  useEffect(() => {
     if (!user) return;
    ws.current = new WebSocket("ws://localhost:3000");

    ws.current.onopen = () => {
      console.log(" WebSocket ì—°ê²°ë¨");
    };

    ws.current.onmessage = (event) => {
      try {
        const msg = JSON.parse(event.data); // event.json âŒ â†’ event.data 
        console.log("ğŸ“¨ ì„œë²„ë¡œë¶€í„° ë°›ì€ ë©”ì‹œì§€:", msg);
        //setMessages((prev) => [...prev, { ...msg, sender: "other" }]);

        if(msg.id === user){
            setSending(false);
        } 
        setMessages((prev) => [...prev,msg]);
      } catch (error) {
        console.error("âŒ ë©”ì‹œì§€ íŒŒì‹± ì˜¤ë¥˜:", event.data);
      }
    };

    ws.current.onclose = () => console.log("âŒ WebSocket ì—°ê²° ì¢…ë£Œ");

    return () => ws.current.close();
  }, [user]);

  //  ë©”ì‹œì§€ ì „ì†¡
  const handleSend = (message) => {
    if (!message.trim()) return;
    if (!user) return alert("ë¡œê·¸ì¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");

    const payload = {
      id: user,
      content: message,
    };

    setSending(true);
    requestAnimationFrame(() => {
    ws.current.send(JSON.stringify(payload));
  });

    //setMessages((prev) => [...prev, { ...payload, sender: "me" }]);
    //ws.current.send(JSON.stringify(payload)); // cureent âŒ â†’ current 
  };

  return (
    <div className="chat-room">
      <ChatHeader id={id} onBack={() => navigate("/chat")} />
      <ChatMessages messages={messages} user={user} sending={sending} />
      <ChatInput onSend={handleSend} />
    </div>
  );
}

export default ChatRoom;
